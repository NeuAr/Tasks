function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var s=0;s<e.length;s++){var a=e[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function _createClass(t,e,s){return e&&_defineProperties(t.prototype,e),s&&_defineProperties(t,s),t}function httpGet(t,e){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;$.ajax({url:t,method:"get"}).done(function(t){e(t)}).fail(function(t){showHttpError(t)}).always(function(){null!=s&&s()})}function httpPost(t,e,s){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;$.ajax({url:t,method:"post",data:e}).done(function(t){s(t)}).fail(function(t){showHttpError(t)}).always(function(){null!=a&&a()})}function showHttpError(t){var e="Произошла ошибка при отправке HTTP-запроса";if(void 0!==t.responseJSON){if(void 0!==t.responseJSON.errors){var s=[];for(var a in t.responseJSON.errors)for(var i in t.responseJSON.errors[a])s.push(t.responseJSON.errors[a][i]);return void showError(s)}void 0!==t.responseJSON.message&&t.responseJSON.message&&t.responseJSON.message.length>0&&(e="Ошибка: "+t.responseJSON.message)}showError(e)}function showError(t){$(".fixed-error-box").remove();var e="fixed-error-box-id-"+Math.floor(1e8*Math.random()),s=$('<div class="fixed-error-box" id="'+e+'"/>');if(Array.isArray(t)){for(var a=$("<div/>"),i=0;i<t.length;++i)i>0&&a.append($("<br/>")),a.append($("<span/>").text(t[i]));s.append(a)}else s.append($("<div/>").text(t));$("body").prepend(s),setTimeout(function(){return $("#"+e).remove()},5e3)}var ApiRoutes=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"getTasksStatistics",value:function(){return"api/tasks/statistics"}},{key:"getTasksList",value:function(){return"api/tasks?status_id="+(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0)+"&is_completed="+(arguments.length>1&&void 0!==arguments[1]?arguments[1]:0)}},{key:"createTask",value:function(){return"api/tasks"}},{key:"updateTask",value:function(t){return"api/tasks/"+t}},{key:"deleteTask",value:function(t){return"api/tasks/"+t}},{key:"makeCompletedTask",value:function(t){return"api/tasks/"+t+"/completed"}},{key:"makeNotCompletedTask",value:function(t){return"api/tasks/"+t+"/not_completed"}}]),t}(),TasksManager=function(){function t(){_classCallCheck(this,t),this.isLocked=!1,this.jGlobalBox=$(".tasks-page-box"),this.jTasksBox=$(".tasks-box"),this.jTaskTemplateBox=$(".task-box.template"),this.token=this.jGlobalBox.attr("token"),this.jTasksTotalCountBox=$(".tasks-statistics-box span.total-count"),this.jTasksActiveCountBox=$(".tasks-statistics-box span.active-count"),this.jFilterSelects=$(".tasks-filter-box select.filter-select"),this.jStatusTasksFilter=$("#status-filter"),this.jCompletedTasksFilter=$("#completed-filter"),this.jTaskEditForm=$(".task-edit-form"),this.jTaskEditFormSaveButton=$(".task-edit-form a.save-button"),this.jChangeTaskStatusField=$("#task-status-field"),this.jChangeTaskTextField=$("#task-text-field"),this.jCreateTaskBox=$(".create-task-box");var e=this;this.jFilterSelects.change(function(){e.updateTasksList()}),this.jCreateTaskBox.find("a").click(function(){return e.showTaskCreateForm(),!1}),this.jTaskEditForm.find("a.save-button").click(function(){return $(this).attr("element-id")<=0?e.createTask():e.changeTask($(this).attr("element-id")),!1}),this.jTaskEditForm.find("a.cancel-button").click(function(){return e.closeTaskEditForm(),!1}),$(".task-box a.completed-button").click(function(){return e.makeCompletedTask($(this).attr("element-id")),!1}),$(".task-box a.not-completed-button").click(function(){return e.makeNotCompletedTask($(this).attr("element-id")),!1}),$(".task-box a.change-button").click(function(){return e.showTaskChangeForm($(this).attr("element-id")),!1}),$(".task-box a.remove-button").click(function(){return e.deleteTask($(this).attr("element-id")),!1})}return _createClass(t,[{key:"lock",value:function(){return!this.isLocked&&(this.isLocked=!0,this.jGlobalBox.addClass("disabled"),this.jFilterSelects.prop("disabled",!0),!0)}},{key:"unlock",value:function(){this.jGlobalBox.removeClass("disabled"),this.jFilterSelects.prop("disabled",!1),this.isLocked=!1}},{key:"getTaskBox",value:function(t){return $("#task-box-"+t)}},{key:"createTaskBox",value:function(t){var e=this.jTaskTemplateBox.clone(!0,!0);return e.removeClass("template"),e.addClass(t.is_completed?"completed":"active"),e.css("background-color",t.related_status.color),e.attr("status-id",t.status_id),e.attr("id","task-box-"+t.id),e.find(".status-box span").text(t.related_status.name),e.find(".text-box span").text(t.text),e.find(".control-box a.control-element").attr("element-id",t.id),e}},{key:"changeTaskBox",value:function(t){var e=this.getTaskBox(t.id);e.removeClass("completed"),e.removeClass("active"),e.addClass(t.is_completed?"completed":"active"),e.css("background-color",t.related_status.color),e.attr("status-id",t.status_id),e.find(".status-box span").text(t.related_status.name),e.find(".text-box span").text(t.text)}},{key:"removeTaskBox",value:function(t){var e=this.getTaskBox(t);e.addClass("deleted"),e.text("Задача ("+t+") удалена")}},{key:"getTaskData",value:function(t){var e=this.getTaskBox(t);return{statusId:parseInt(e.attr("status-id")),text:e.find(".text-box span").text()}}},{key:"getValuesTaskEditForm",value:function(){return{statusId:parseInt(this.jChangeTaskStatusField.val()),text:this.jChangeTaskTextField.val()}}},{key:"setValuesTaskEditForm",value:function(t){this.jChangeTaskStatusField.val(t.statusId),this.jChangeTaskTextField.val(t.text)}},{key:"clearValuesTaskEditForm",value:function(){this.setValuesTaskEditForm({statusId:0,text:""})}},{key:"showTaskCreateForm",value:function(){this.lock()&&(this.clearValuesTaskEditForm(),this.jTaskEditFormSaveButton.attr("element-id",0),this.jCreateTaskBox.after(this.jTaskEditForm),this.jTaskEditForm.css("display","block"),this.unlock())}},{key:"showTaskChangeForm",value:function(t){if(this.lock()){var e=this.getTaskData(t),s=this.getTaskBox(t);this.setValuesTaskEditForm(e),this.jTaskEditFormSaveButton.attr("element-id",t),s.after(this.jTaskEditForm),this.jTaskEditForm.css("display","block"),this.unlock()}}},{key:"hiddenTaskEditForm",value:function(){this.jTaskEditForm.css("display","none"),this.jCreateTaskBox.after(this.jTaskEditForm)}},{key:"closeTaskEditForm",value:function(){this.lock()&&(this.hiddenTaskEditForm(),this.unlock())}},{key:"updateTasksStatistics",value:function(){var t=this;httpGet(ApiRoutes.getTasksStatistics(),function(e){t.jTasksTotalCountBox.text(e.count),t.jTasksActiveCountBox.text(e.active_count)})}},{key:"updateTasksList",value:function(){if(this.lock()){var t=this,e=this.jStatusTasksFilter.val(),s=this.jCompletedTasksFilter.val();httpGet(ApiRoutes.getTasksList(e,s),function(e){t.hiddenTaskEditForm(),t.jTasksBox.html("");for(var s=0;s<e.length;++s){var a=t.createTaskBox(e[s]);t.jTasksBox.append(a)}},function(){t.unlock()})}}},{key:"getEditTaskHttpData",value:function(){var t=this.getValuesTaskEditForm();return"status_id="+t.statusId+"&text="+encodeURIComponent(t.text)}},{key:"getTaskActionHttpData",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"POST",e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return"_token="+this.token+"&_method="+t+(e?"&"+this.getEditTaskHttpData():"")}},{key:"sendTaskActionHttpRequest",value:function(t,e){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"POST",a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(this.lock()){var i=this;httpPost(t,this.getTaskActionHttpData(s,a),function(t){e(t,i)},function(){i.unlock()})}}},{key:"createTask",value:function(){this.sendTaskActionHttpRequest(ApiRoutes.createTask(),function(t,e){var s=e.createTaskBox(t);e.jTasksBox.prepend(s),e.updateTasksStatistics(),e.clearValuesTaskEditForm()},"POST",!0)}},{key:"changeTask",value:function(t){this.sendTaskActionHttpRequest(ApiRoutes.updateTask(t),function(t,e){e.changeTaskBox(t),e.hiddenTaskEditForm()},"PUT",!0)}},{key:"deleteTask",value:function(t){this.sendTaskActionHttpRequest(ApiRoutes.deleteTask(t),function(e,s){s.removeTaskBox(t),s.updateTasksStatistics(),s.hiddenTaskEditForm()},"DELETE")}},{key:"makeCompletedTask",value:function(t){this.sendTaskActionHttpRequest(ApiRoutes.makeCompletedTask(t),function(t,e){e.changeTaskBox(t),e.updateTasksStatistics(),e.hiddenTaskEditForm()},"PATCH")}},{key:"makeNotCompletedTask",value:function(t){this.sendTaskActionHttpRequest(ApiRoutes.makeNotCompletedTask(t),function(t,e){e.changeTaskBox(t),e.updateTasksStatistics(),e.hiddenTaskEditForm()},"PATCH")}}],[{key:"create",value:function(){return new t}}]),t}();$(function(){"use strict";TasksManager.create()});
